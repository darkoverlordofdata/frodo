(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var AppRouter, models, utils, views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

utils = require('./utils');

views = require('./views');

models = require('./models');

require('./models/Wine');

require('./models/WineCollection');

require('./views/AboutView');

require('./views/HeaderView');

require('./views/HomeView');

require('./views/Paginator');

require('./views/WineView');

require('./views/WineListView');

require('./views/WineListItemView');

AppRouter = (function(_super) {
  __extends(AppRouter, _super);

  AppRouter.prototype.routes = {
    "": "home",
    "wines": "list",
    "wines/page/:page": "list",
    "wines/add": "addWine",
    "wines/:id": "wineDetails",
    "about": "about"
  };

  function AppRouter() {
    AppRouter.__super__.constructor.apply(this, arguments);
    this.headerView = new views.HeaderView();
    $(".header").html(this.headerView.el);
  }

  AppRouter.prototype.home = function(id) {
    if (!this.homeView) {
      this.homeView = new views.HomeView();
    }
    $("#content").html(this.homeView.el);
    return this.headerView.selectMenuItem("home-menu");
  };

  AppRouter.prototype.list = function(page) {
    var p, wineList;
    p = page ? parseInt(page, 10) : 1;
    wineList = new models.WineCollection();
    wineList.fetch({
      success: function() {
        return $("#content").html(new views.WineListView({
          model: wineList,
          page: p
        }).el);
      }
    });
    return this.headerView.selectMenuItem("home-menu");
  };

  AppRouter.prototype.wineDetails = function(id) {
    var wine;
    wine = new models.Wine({
      _id: id
    });
    wine.fetch({
      success: function() {
        return $("#content").html(new views.WineView({
          model: wine
        }).el);
      }
    });
    return this.headerView.selectMenuItem();
  };

  AppRouter.prototype.addWine = function() {
    var wine;
    wine = new models.Wine();
    $("#content").html(new views.WineView({
      model: wine
    }).el);
    return this.headerView.selectMenuItem("add-menu");
  };

  AppRouter.prototype.about = function() {
    if (!this.aboutView) {
      this.aboutView = new views.AboutView();
    }
    $("#content").html(this.aboutView.el);
    return this.headerView.selectMenuItem("about-menu");
  };

  return AppRouter;

})(Backbone.Router);

utils.loadTemplate(["HomeView", "HeaderView", "WineView", "WineListItemView", "AboutView"], function() {
  new AppRouter;
  return Backbone.history.start();
});

},{"./models":2,"./models/Wine":3,"./models/WineCollection":4,"./utils":5,"./views":6,"./views/AboutView":7,"./views/HeaderView":8,"./views/HomeView":9,"./views/Paginator":10,"./views/WineListItemView":11,"./views/WineListView":12,"./views/WineView":13}],2:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1


},{}],3:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var models,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

models = require('../models');

models.Wine = (function(_super) {
  __extends(Wine, _super);

  Wine.prototype.urlRoot = "/wines";

  Wine.prototype.idAttribute = "_id";

  function Wine() {
    Wine.__super__.constructor.apply(this, arguments);
    this.validators = {};
    this.validators.name = function(value) {
      if (value.length > 0) {
        return {
          isValid: true
        };
      } else {
        return {
          isValid: false,
          message: "You must enter a name"
        };
      }
    };
    this.validators.grapes = function(value) {
      if (value.length > 0) {
        return {
          isValid: true
        };
      } else {
        return {
          isValid: false,
          message: "You must enter a grape variety"
        };
      }
    };
    this.validators.country = function(value) {
      if (value.length > 0) {
        return {
          isValid: true
        };
      } else {
        return {
          isValid: false,
          message: "You must enter a country"
        };
      }
    };
  }

  Wine.prototype.validateItem = function(key) {
    if (this.validators[key]) {
      return this.validators[key](this.get(key));
    } else {
      return {
        isValid: true
      };
    }
  };

  Wine.prototype.validateAll = function() {
    var check, key, messages;
    messages = {};
    for (key in this.validators) {
      if (this.validators.hasOwnProperty(key)) {
        check = this.validators[key](this.get(key));
        if (check.isValid === false) {
          messages[key] = check.message;
        }
      }
    }
    if (_.size(messages) > 0) {
      return {
        isValid: false,
        messages: messages
      };
    } else {
      return {
        isValid: true
      };
    }
  };

  Wine.prototype.defaults = {
    _id: null,
    name: "",
    grapes: "",
    country: "USA",
    region: "California",
    year: "",
    description: "",
    picture: null
  };

  return Wine;

})(Backbone.Model);

},{"../models":2}],4:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var models,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

models = require('../models');

models.WineCollection = (function(_super) {
  __extends(WineCollection, _super);

  function WineCollection() {
    return WineCollection.__super__.constructor.apply(this, arguments);
  }

  WineCollection.prototype.model = models.Wine;

  WineCollection.prototype.url = "/wines";

  return WineCollection;

})(Backbone.Collection);

},{"../models":2}],5:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var DOMFileSystem, classes;

classes = require('./views');

DOMFileSystem = (function() {
  function DOMFileSystem() {}

  DOMFileSystem.prototype.readTemplateFile = function($template) {
    var el;
    if ((el = $('#' + $template)) != null) {
      return el.text();
    } else {
      throw Liquid.FileSystemError("Template not found: " + $template);
    }
  };

  return DOMFileSystem;

})();

Liquid.Template.fileSystem = new DOMFileSystem;

module.exports = {
  loadTemplate: function(views, callback) {
    var deferreds;
    deferreds = [];
    $.each(views, function(index, view) {
      if (classes[view]) {
        return deferreds.push($.get("tpl/" + view + ".liquid", function(template) {
          return classes[view].prototype.template = Liquid.Template.parse(template);
        }));
      } else {
        return alert(view + " not found");
      }
    });
    return $.when.apply(null, deferreds).done(callback);
  },
  displayValidationErrors: function(messages) {
    var key;
    for (key in messages) {
      if (messages.hasOwnProperty(key)) {
        this.addValidationError(key, messages[key]);
      }
    }
    return this.showAlert("Warning!", "Fix validation errors and try again", "alert-warning");
  },
  addValidationError: function(field, message) {
    var controlGroup;
    controlGroup = $("#" + field).parent().parent();
    controlGroup.addClass("error");
    return $(".help-inline", controlGroup).html(message);
  },
  removeValidationError: function(field) {
    var controlGroup;
    controlGroup = $("#" + field).parent().parent();
    controlGroup.removeClass("error");
    return $(".help-inline", controlGroup).html("");
  },
  showAlert: function(title, text, klass) {
    $(".alert").removeClass("alert-error alert-warning alert-success alert-info");
    $(".alert").addClass(klass);
    $(".alert").html("<strong>" + title + "</strong> " + text);
    return $(".alert").show();
  },
  hideAlert: function() {
    return $(".alert").hide();
  }
};

},{"./views":6}],6:[function(require,module,exports){
module.exports=require(2)
},{}],7:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

views = require('../views');

views.AboutView = (function(_super) {
  __extends(AboutView, _super);

  function AboutView(options) {
    this.options = options;
    AboutView.__super__.constructor.apply(this, arguments);
    this.render();
  }

  AboutView.prototype.render = function() {
    $(this.el).html(this.template.render());
    return this;
  };

  return AboutView;

})(Backbone.View);

},{"../views":6}],8:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

views = require('../views');

views.HeaderView = (function(_super) {
  __extends(HeaderView, _super);

  function HeaderView(options) {
    this.options = options;
    HeaderView.__super__.constructor.apply(this, arguments);
    this.render();
  }

  HeaderView.prototype.render = function() {
    $(this.el).html(this.template.render());
    return this;
  };

  HeaderView.prototype.selectMenuItem = function(menuItem) {
    $(".nav li").removeClass("active");
    if (menuItem) {
      return $("." + menuItem).addClass("active");
    }
  };

  return HeaderView;

})(Backbone.View);

},{"../views":6}],9:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

views = require('../views');

views.HomeView = (function(_super) {
  __extends(HomeView, _super);

  function HomeView(options) {
    this.options = options;
    HomeView.__super__.constructor.apply(this, arguments);
    this.render();
  }

  HomeView.prototype.render = function() {
    $(this.el).html(this.template.render());
    return this;
  };

  return HomeView;

})(Backbone.View);

},{"../views":6}],10:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

views = require('../views');

views.Paginator = (function(_super) {
  __extends(Paginator, _super);

  Paginator.prototype.className = "pagination pagination-centered";

  function Paginator(options) {
    this.options = options;
    Paginator.__super__.constructor.apply(this, arguments);
    this.model.bind("reset", this.render, this);
    this.render();
  }

  Paginator.prototype.render = function() {
    var i, items, len, pageCount;
    items = this.model.models;
    len = items.length;
    pageCount = Math.ceil(len / 8);
    $(this.el).html("<ul />");
    i = 0;
    while (i < pageCount) {
      $("ul", this.el).append("<li" + ((i + 1) === this.options.page ? " class='active'" : "") + "><a href='#wines/page/" + (i + 1) + "'>" + (i + 1) + "</a></li>");
      i++;
    }
    return this;
  };

  return Paginator;

})(Backbone.View);

},{"../views":6}],11:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

views = require('../views');

views.WineListItemView = (function(_super) {
  __extends(WineListItemView, _super);

  WineListItemView.prototype.tagName = "li";

  function WineListItemView(options) {
    this.options = options;
    WineListItemView.__super__.constructor.apply(this, arguments);
    this.model.bind("change", this.render, this);
    this.model.bind("destroy", this.close, this);
  }

  WineListItemView.prototype.render = function() {
    $(this.el).html(this.template.render(this.model.toJSON()));
    return this;
  };

  return WineListItemView;

})(Backbone.View);

},{"../views":6}],12:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

views = require('../views');

views.WineListView = (function(_super) {
  __extends(WineListView, _super);

  function WineListView(options) {
    this.options = options;
    WineListView.__super__.constructor.apply(this, arguments);
    this.render();
  }

  WineListView.prototype.render = function() {
    var endPos, i, len, startPos, wines;
    wines = this.model.models;
    len = wines.length;
    startPos = (this.options.page - 1) * 8;
    endPos = Math.min(startPos + 8, len);
    $(this.el).html("<ul class=\"thumbnails\"></ul>");
    i = startPos;
    while (i < endPos) {
      $(".thumbnails", this.el).append(new views.WineListItemView({
        model: wines[i]
      }).render().el);
      i++;
    }
    $(this.el).append(new views.Paginator({
      model: this.model,
      page: this.options.page
    }).render().el);
    return this;
  };

  return WineListView;

})(Backbone.View);

},{"../views":6}],13:[function(require,module,exports){
// Generated by CoffeeScript 1.7.1
var utils, views,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

utils = require('../utils');

views = require('../views');

views.WineView = (function(_super) {
  __extends(WineView, _super);

  function WineView(options) {
    this.options = options;
    WineView.__super__.constructor.apply(this, arguments);
    this.render();
  }

  WineView.prototype.render = function() {
    $(this.el).html(this.template.render(this.model.toJSON()));
    return this;
  };

  WineView.prototype.events = function() {
    return {
      "change": "change",
      "click .save": "beforeSave",
      "click .delete": "deleteWine",
      "drop #picture": "dropHandler"
    };
  };

  WineView.prototype.change = function(event) {
    var change, check, target;
    utils.hideAlert();
    target = event.target;
    change = {};
    change[target.name] = target.value;
    this.model.set(change);
    check = this.model.validateItem(target.id);
    if (check.isValid === false) {
      return utils.addValidationError(target.id, check.message);
    } else {
      return utils.removeValidationError(target.id);
    }
  };

  WineView.prototype.beforeSave = function() {
    var check;
    check = this.model.validateAll();
    if (check.isValid === false) {
      utils.displayValidationErrors(check.messages);
      return false;
    }
    this.saveWine();
    return false;
  };

  WineView.prototype.saveWine = function() {
    console.log("before save");
    return this.model.save(null, {
      success: (function(_this) {
        return function(model) {
          _this.render();
          app.navigate("wines/" + model.id, false);
          return utils.showAlert("Success!", "Wine saved successfully", "alert-success");
        };
      })(this),
      error: function() {
        return utils.showAlert("Error", "An error occurred while trying to delete this item", "alert-error");
      }
    });
  };

  WineView.prototype.deleteWine = function() {
    this.model.destroy({
      success: function() {
        alert("Wine deleted successfully");
        return window.history.back();
      }
    });
    return false;
  };

  WineView.prototype.dropHandler = function(event) {
    var e, reader;
    event.stopPropagation();
    event.preventDefault();
    e = event.originalEvent;
    e.dataTransfer.dropEffect = "copy";
    this.pictureFile = e.dataTransfer.files[0];
    reader = new FileReader();
    reader.onloadend = function() {
      return $("#picture").attr("src", reader.result);
    };
    return reader.readAsDataURL(this.pictureFile);
  };

  return WineView;

})(Backbone.View);

},{"../utils":5,"../views":6}]},{},[1])
//@ sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2VuZXJhdGVkLmpzIiwic291cmNlcyI6WyIvaG9tZS9icnVjZS9PcGVuU2hpZnQvZnJvZG8vdG1wL25jL21haW4uanMiLCIvaG9tZS9icnVjZS9PcGVuU2hpZnQvZnJvZG8vdG1wL25jL21vZGVscy5qcyIsIi9ob21lL2JydWNlL09wZW5TaGlmdC9mcm9kby90bXAvbmMvbW9kZWxzL1dpbmUuanMiLCIvaG9tZS9icnVjZS9PcGVuU2hpZnQvZnJvZG8vdG1wL25jL21vZGVscy9XaW5lQ29sbGVjdGlvbi5qcyIsIi9ob21lL2JydWNlL09wZW5TaGlmdC9mcm9kby90bXAvbmMvdXRpbHMuanMiLCIvaG9tZS9icnVjZS9PcGVuU2hpZnQvZnJvZG8vdG1wL25jL3ZpZXdzL0Fib3V0Vmlldy5qcyIsIi9ob21lL2JydWNlL09wZW5TaGlmdC9mcm9kby90bXAvbmMvdmlld3MvSGVhZGVyVmlldy5qcyIsIi9ob21lL2JydWNlL09wZW5TaGlmdC9mcm9kby90bXAvbmMvdmlld3MvSG9tZVZpZXcuanMiLCIvaG9tZS9icnVjZS9PcGVuU2hpZnQvZnJvZG8vdG1wL25jL3ZpZXdzL1BhZ2luYXRvci5qcyIsIi9ob21lL2JydWNlL09wZW5TaGlmdC9mcm9kby90bXAvbmMvdmlld3MvV2luZUxpc3RJdGVtVmlldy5qcyIsIi9ob21lL2JydWNlL09wZW5TaGlmdC9mcm9kby90bXAvbmMvdmlld3MvV2luZUxpc3RWaWV3LmpzIiwiL2hvbWUvYnJ1Y2UvT3BlblNoaWZ0L2Zyb2RvL3RtcC9uYy92aWV3cy9XaW5lVmlldy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQzlHQTtBQUNBO0FBQ0E7O0FDRkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDdEdBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3JCQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7OztBQ3JFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN4QkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMvQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7O0FDeEJBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQ3BDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUMzQkE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTs7QUN4Q0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIEFwcFJvdXRlciwgbW9kZWxzLCB1dGlscywgdmlld3MsXG4gIF9faGFzUHJvcCA9IHt9Lmhhc093blByb3BlcnR5LFxuICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTtcblxudXRpbHMgPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5cbnZpZXdzID0gcmVxdWlyZSgnLi92aWV3cycpO1xuXG5tb2RlbHMgPSByZXF1aXJlKCcuL21vZGVscycpO1xuXG5yZXF1aXJlKCcuL21vZGVscy9XaW5lJyk7XG5cbnJlcXVpcmUoJy4vbW9kZWxzL1dpbmVDb2xsZWN0aW9uJyk7XG5cbnJlcXVpcmUoJy4vdmlld3MvQWJvdXRWaWV3Jyk7XG5cbnJlcXVpcmUoJy4vdmlld3MvSGVhZGVyVmlldycpO1xuXG5yZXF1aXJlKCcuL3ZpZXdzL0hvbWVWaWV3Jyk7XG5cbnJlcXVpcmUoJy4vdmlld3MvUGFnaW5hdG9yJyk7XG5cbnJlcXVpcmUoJy4vdmlld3MvV2luZVZpZXcnKTtcblxucmVxdWlyZSgnLi92aWV3cy9XaW5lTGlzdFZpZXcnKTtcblxucmVxdWlyZSgnLi92aWV3cy9XaW5lTGlzdEl0ZW1WaWV3Jyk7XG5cbkFwcFJvdXRlciA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgX19leHRlbmRzKEFwcFJvdXRlciwgX3N1cGVyKTtcblxuICBBcHBSb3V0ZXIucHJvdG90eXBlLnJvdXRlcyA9IHtcbiAgICBcIlwiOiBcImhvbWVcIixcbiAgICBcIndpbmVzXCI6IFwibGlzdFwiLFxuICAgIFwid2luZXMvcGFnZS86cGFnZVwiOiBcImxpc3RcIixcbiAgICBcIndpbmVzL2FkZFwiOiBcImFkZFdpbmVcIixcbiAgICBcIndpbmVzLzppZFwiOiBcIndpbmVEZXRhaWxzXCIsXG4gICAgXCJhYm91dFwiOiBcImFib3V0XCJcbiAgfTtcblxuICBmdW5jdGlvbiBBcHBSb3V0ZXIoKSB7XG4gICAgQXBwUm91dGVyLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIHRoaXMuaGVhZGVyVmlldyA9IG5ldyB2aWV3cy5IZWFkZXJWaWV3KCk7XG4gICAgJChcIi5oZWFkZXJcIikuaHRtbCh0aGlzLmhlYWRlclZpZXcuZWwpO1xuICB9XG5cbiAgQXBwUm91dGVyLnByb3RvdHlwZS5ob21lID0gZnVuY3Rpb24oaWQpIHtcbiAgICBpZiAoIXRoaXMuaG9tZVZpZXcpIHtcbiAgICAgIHRoaXMuaG9tZVZpZXcgPSBuZXcgdmlld3MuSG9tZVZpZXcoKTtcbiAgICB9XG4gICAgJChcIiNjb250ZW50XCIpLmh0bWwodGhpcy5ob21lVmlldy5lbCk7XG4gICAgcmV0dXJuIHRoaXMuaGVhZGVyVmlldy5zZWxlY3RNZW51SXRlbShcImhvbWUtbWVudVwiKTtcbiAgfTtcblxuICBBcHBSb3V0ZXIucHJvdG90eXBlLmxpc3QgPSBmdW5jdGlvbihwYWdlKSB7XG4gICAgdmFyIHAsIHdpbmVMaXN0O1xuICAgIHAgPSBwYWdlID8gcGFyc2VJbnQocGFnZSwgMTApIDogMTtcbiAgICB3aW5lTGlzdCA9IG5ldyBtb2RlbHMuV2luZUNvbGxlY3Rpb24oKTtcbiAgICB3aW5lTGlzdC5mZXRjaCh7XG4gICAgICBzdWNjZXNzOiBmdW5jdGlvbigpIHtcbiAgICAgICAgcmV0dXJuICQoXCIjY29udGVudFwiKS5odG1sKG5ldyB2aWV3cy5XaW5lTGlzdFZpZXcoe1xuICAgICAgICAgIG1vZGVsOiB3aW5lTGlzdCxcbiAgICAgICAgICBwYWdlOiBwXG4gICAgICAgIH0pLmVsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5oZWFkZXJWaWV3LnNlbGVjdE1lbnVJdGVtKFwiaG9tZS1tZW51XCIpO1xuICB9O1xuXG4gIEFwcFJvdXRlci5wcm90b3R5cGUud2luZURldGFpbHMgPSBmdW5jdGlvbihpZCkge1xuICAgIHZhciB3aW5lO1xuICAgIHdpbmUgPSBuZXcgbW9kZWxzLldpbmUoe1xuICAgICAgX2lkOiBpZFxuICAgIH0pO1xuICAgIHdpbmUuZmV0Y2goe1xuICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiAkKFwiI2NvbnRlbnRcIikuaHRtbChuZXcgdmlld3MuV2luZVZpZXcoe1xuICAgICAgICAgIG1vZGVsOiB3aW5lXG4gICAgICAgIH0pLmVsKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gdGhpcy5oZWFkZXJWaWV3LnNlbGVjdE1lbnVJdGVtKCk7XG4gIH07XG5cbiAgQXBwUm91dGVyLnByb3RvdHlwZS5hZGRXaW5lID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIHdpbmU7XG4gICAgd2luZSA9IG5ldyBtb2RlbHMuV2luZSgpO1xuICAgICQoXCIjY29udGVudFwiKS5odG1sKG5ldyB2aWV3cy5XaW5lVmlldyh7XG4gICAgICBtb2RlbDogd2luZVxuICAgIH0pLmVsKTtcbiAgICByZXR1cm4gdGhpcy5oZWFkZXJWaWV3LnNlbGVjdE1lbnVJdGVtKFwiYWRkLW1lbnVcIik7XG4gIH07XG5cbiAgQXBwUm91dGVyLnByb3RvdHlwZS5hYm91dCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmICghdGhpcy5hYm91dFZpZXcpIHtcbiAgICAgIHRoaXMuYWJvdXRWaWV3ID0gbmV3IHZpZXdzLkFib3V0VmlldygpO1xuICAgIH1cbiAgICAkKFwiI2NvbnRlbnRcIikuaHRtbCh0aGlzLmFib3V0Vmlldy5lbCk7XG4gICAgcmV0dXJuIHRoaXMuaGVhZGVyVmlldy5zZWxlY3RNZW51SXRlbShcImFib3V0LW1lbnVcIik7XG4gIH07XG5cbiAgcmV0dXJuIEFwcFJvdXRlcjtcblxufSkoQmFja2JvbmUuUm91dGVyKTtcblxudXRpbHMubG9hZFRlbXBsYXRlKFtcIkhvbWVWaWV3XCIsIFwiSGVhZGVyVmlld1wiLCBcIldpbmVWaWV3XCIsIFwiV2luZUxpc3RJdGVtVmlld1wiLCBcIkFib3V0Vmlld1wiXSwgZnVuY3Rpb24oKSB7XG4gIG5ldyBBcHBSb3V0ZXI7XG4gIHJldHVybiBCYWNrYm9uZS5oaXN0b3J5LnN0YXJ0KCk7XG59KTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS43LjFcblxuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIG1vZGVscyxcbiAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG5tb2RlbHMgPSByZXF1aXJlKCcuLi9tb2RlbHMnKTtcblxubW9kZWxzLldpbmUgPSAoZnVuY3Rpb24oX3N1cGVyKSB7XG4gIF9fZXh0ZW5kcyhXaW5lLCBfc3VwZXIpO1xuXG4gIFdpbmUucHJvdG90eXBlLnVybFJvb3QgPSBcIi93aW5lc1wiO1xuXG4gIFdpbmUucHJvdG90eXBlLmlkQXR0cmlidXRlID0gXCJfaWRcIjtcblxuICBmdW5jdGlvbiBXaW5lKCkge1xuICAgIFdpbmUuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgdGhpcy52YWxpZGF0b3JzID0ge307XG4gICAgdGhpcy52YWxpZGF0b3JzLm5hbWUgPSBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1ZhbGlkOiB0cnVlXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IFwiWW91IG11c3QgZW50ZXIgYSBuYW1lXCJcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMudmFsaWRhdG9ycy5ncmFwZXMgPSBmdW5jdGlvbih2YWx1ZSkge1xuICAgICAgaWYgKHZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1ZhbGlkOiB0cnVlXG4gICAgICAgIH07XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGlzVmFsaWQ6IGZhbHNlLFxuICAgICAgICAgIG1lc3NhZ2U6IFwiWW91IG11c3QgZW50ZXIgYSBncmFwZSB2YXJpZXR5XCJcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9O1xuICAgIHRoaXMudmFsaWRhdG9ycy5jb3VudHJ5ID0gZnVuY3Rpb24odmFsdWUpIHtcbiAgICAgIGlmICh2YWx1ZS5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaXNWYWxpZDogdHJ1ZVxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBpc1ZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBtZXNzYWdlOiBcIllvdSBtdXN0IGVudGVyIGEgY291bnRyeVwiXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIFdpbmUucHJvdG90eXBlLnZhbGlkYXRlSXRlbSA9IGZ1bmN0aW9uKGtleSkge1xuICAgIGlmICh0aGlzLnZhbGlkYXRvcnNba2V5XSkge1xuICAgICAgcmV0dXJuIHRoaXMudmFsaWRhdG9yc1trZXldKHRoaXMuZ2V0KGtleSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc1ZhbGlkOiB0cnVlXG4gICAgICB9O1xuICAgIH1cbiAgfTtcblxuICBXaW5lLnByb3RvdHlwZS52YWxpZGF0ZUFsbCA9IGZ1bmN0aW9uKCkge1xuICAgIHZhciBjaGVjaywga2V5LCBtZXNzYWdlcztcbiAgICBtZXNzYWdlcyA9IHt9O1xuICAgIGZvciAoa2V5IGluIHRoaXMudmFsaWRhdG9ycykge1xuICAgICAgaWYgKHRoaXMudmFsaWRhdG9ycy5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgICAgIGNoZWNrID0gdGhpcy52YWxpZGF0b3JzW2tleV0odGhpcy5nZXQoa2V5KSk7XG4gICAgICAgIGlmIChjaGVjay5pc1ZhbGlkID09PSBmYWxzZSkge1xuICAgICAgICAgIG1lc3NhZ2VzW2tleV0gPSBjaGVjay5tZXNzYWdlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIGlmIChfLnNpemUobWVzc2FnZXMpID4gMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNWYWxpZDogZmFsc2UsXG4gICAgICAgIG1lc3NhZ2VzOiBtZXNzYWdlc1xuICAgICAgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNWYWxpZDogdHJ1ZVxuICAgICAgfTtcbiAgICB9XG4gIH07XG5cbiAgV2luZS5wcm90b3R5cGUuZGVmYXVsdHMgPSB7XG4gICAgX2lkOiBudWxsLFxuICAgIG5hbWU6IFwiXCIsXG4gICAgZ3JhcGVzOiBcIlwiLFxuICAgIGNvdW50cnk6IFwiVVNBXCIsXG4gICAgcmVnaW9uOiBcIkNhbGlmb3JuaWFcIixcbiAgICB5ZWFyOiBcIlwiLFxuICAgIGRlc2NyaXB0aW9uOiBcIlwiLFxuICAgIHBpY3R1cmU6IG51bGxcbiAgfTtcblxuICByZXR1cm4gV2luZTtcblxufSkoQmFja2JvbmUuTW9kZWwpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIG1vZGVscyxcbiAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG5tb2RlbHMgPSByZXF1aXJlKCcuLi9tb2RlbHMnKTtcblxubW9kZWxzLldpbmVDb2xsZWN0aW9uID0gKGZ1bmN0aW9uKF9zdXBlcikge1xuICBfX2V4dGVuZHMoV2luZUNvbGxlY3Rpb24sIF9zdXBlcik7XG5cbiAgZnVuY3Rpb24gV2luZUNvbGxlY3Rpb24oKSB7XG4gICAgcmV0dXJuIFdpbmVDb2xsZWN0aW9uLl9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICB9XG5cbiAgV2luZUNvbGxlY3Rpb24ucHJvdG90eXBlLm1vZGVsID0gbW9kZWxzLldpbmU7XG5cbiAgV2luZUNvbGxlY3Rpb24ucHJvdG90eXBlLnVybCA9IFwiL3dpbmVzXCI7XG5cbiAgcmV0dXJuIFdpbmVDb2xsZWN0aW9uO1xuXG59KShCYWNrYm9uZS5Db2xsZWN0aW9uKTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS43LjFcbnZhciBET01GaWxlU3lzdGVtLCBjbGFzc2VzO1xuXG5jbGFzc2VzID0gcmVxdWlyZSgnLi92aWV3cycpO1xuXG5ET01GaWxlU3lzdGVtID0gKGZ1bmN0aW9uKCkge1xuICBmdW5jdGlvbiBET01GaWxlU3lzdGVtKCkge31cblxuICBET01GaWxlU3lzdGVtLnByb3RvdHlwZS5yZWFkVGVtcGxhdGVGaWxlID0gZnVuY3Rpb24oJHRlbXBsYXRlKSB7XG4gICAgdmFyIGVsO1xuICAgIGlmICgoZWwgPSAkKCcjJyArICR0ZW1wbGF0ZSkpICE9IG51bGwpIHtcbiAgICAgIHJldHVybiBlbC50ZXh0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IExpcXVpZC5GaWxlU3lzdGVtRXJyb3IoXCJUZW1wbGF0ZSBub3QgZm91bmQ6IFwiICsgJHRlbXBsYXRlKTtcbiAgICB9XG4gIH07XG5cbiAgcmV0dXJuIERPTUZpbGVTeXN0ZW07XG5cbn0pKCk7XG5cbkxpcXVpZC5UZW1wbGF0ZS5maWxlU3lzdGVtID0gbmV3IERPTUZpbGVTeXN0ZW07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBsb2FkVGVtcGxhdGU6IGZ1bmN0aW9uKHZpZXdzLCBjYWxsYmFjaykge1xuICAgIHZhciBkZWZlcnJlZHM7XG4gICAgZGVmZXJyZWRzID0gW107XG4gICAgJC5lYWNoKHZpZXdzLCBmdW5jdGlvbihpbmRleCwgdmlldykge1xuICAgICAgaWYgKGNsYXNzZXNbdmlld10pIHtcbiAgICAgICAgcmV0dXJuIGRlZmVycmVkcy5wdXNoKCQuZ2V0KFwidHBsL1wiICsgdmlldyArIFwiLmxpcXVpZFwiLCBmdW5jdGlvbih0ZW1wbGF0ZSkge1xuICAgICAgICAgIHJldHVybiBjbGFzc2VzW3ZpZXddLnByb3RvdHlwZS50ZW1wbGF0ZSA9IExpcXVpZC5UZW1wbGF0ZS5wYXJzZSh0ZW1wbGF0ZSk7XG4gICAgICAgIH0pKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBhbGVydCh2aWV3ICsgXCIgbm90IGZvdW5kXCIpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiAkLndoZW4uYXBwbHkobnVsbCwgZGVmZXJyZWRzKS5kb25lKGNhbGxiYWNrKTtcbiAgfSxcbiAgZGlzcGxheVZhbGlkYXRpb25FcnJvcnM6IGZ1bmN0aW9uKG1lc3NhZ2VzKSB7XG4gICAgdmFyIGtleTtcbiAgICBmb3IgKGtleSBpbiBtZXNzYWdlcykge1xuICAgICAgaWYgKG1lc3NhZ2VzLmhhc093blByb3BlcnR5KGtleSkpIHtcbiAgICAgICAgdGhpcy5hZGRWYWxpZGF0aW9uRXJyb3Ioa2V5LCBtZXNzYWdlc1trZXldKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuc2hvd0FsZXJ0KFwiV2FybmluZyFcIiwgXCJGaXggdmFsaWRhdGlvbiBlcnJvcnMgYW5kIHRyeSBhZ2FpblwiLCBcImFsZXJ0LXdhcm5pbmdcIik7XG4gIH0sXG4gIGFkZFZhbGlkYXRpb25FcnJvcjogZnVuY3Rpb24oZmllbGQsIG1lc3NhZ2UpIHtcbiAgICB2YXIgY29udHJvbEdyb3VwO1xuICAgIGNvbnRyb2xHcm91cCA9ICQoXCIjXCIgKyBmaWVsZCkucGFyZW50KCkucGFyZW50KCk7XG4gICAgY29udHJvbEdyb3VwLmFkZENsYXNzKFwiZXJyb3JcIik7XG4gICAgcmV0dXJuICQoXCIuaGVscC1pbmxpbmVcIiwgY29udHJvbEdyb3VwKS5odG1sKG1lc3NhZ2UpO1xuICB9LFxuICByZW1vdmVWYWxpZGF0aW9uRXJyb3I6IGZ1bmN0aW9uKGZpZWxkKSB7XG4gICAgdmFyIGNvbnRyb2xHcm91cDtcbiAgICBjb250cm9sR3JvdXAgPSAkKFwiI1wiICsgZmllbGQpLnBhcmVudCgpLnBhcmVudCgpO1xuICAgIGNvbnRyb2xHcm91cC5yZW1vdmVDbGFzcyhcImVycm9yXCIpO1xuICAgIHJldHVybiAkKFwiLmhlbHAtaW5saW5lXCIsIGNvbnRyb2xHcm91cCkuaHRtbChcIlwiKTtcbiAgfSxcbiAgc2hvd0FsZXJ0OiBmdW5jdGlvbih0aXRsZSwgdGV4dCwga2xhc3MpIHtcbiAgICAkKFwiLmFsZXJ0XCIpLnJlbW92ZUNsYXNzKFwiYWxlcnQtZXJyb3IgYWxlcnQtd2FybmluZyBhbGVydC1zdWNjZXNzIGFsZXJ0LWluZm9cIik7XG4gICAgJChcIi5hbGVydFwiKS5hZGRDbGFzcyhrbGFzcyk7XG4gICAgJChcIi5hbGVydFwiKS5odG1sKFwiPHN0cm9uZz5cIiArIHRpdGxlICsgXCI8L3N0cm9uZz4gXCIgKyB0ZXh0KTtcbiAgICByZXR1cm4gJChcIi5hbGVydFwiKS5zaG93KCk7XG4gIH0sXG4gIGhpZGVBbGVydDogZnVuY3Rpb24oKSB7XG4gICAgcmV0dXJuICQoXCIuYWxlcnRcIikuaGlkZSgpO1xuICB9XG59O1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIHZpZXdzLFxuICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbnZpZXdzID0gcmVxdWlyZSgnLi4vdmlld3MnKTtcblxudmlld3MuQWJvdXRWaWV3ID0gKGZ1bmN0aW9uKF9zdXBlcikge1xuICBfX2V4dGVuZHMoQWJvdXRWaWV3LCBfc3VwZXIpO1xuXG4gIGZ1bmN0aW9uIEFib3V0VmlldyhvcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICBBYm91dFZpZXcuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIEFib3V0Vmlldy5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgJCh0aGlzLmVsKS5odG1sKHRoaXMudGVtcGxhdGUucmVuZGVyKCkpO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIHJldHVybiBBYm91dFZpZXc7XG5cbn0pKEJhY2tib25lLlZpZXcpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIHZpZXdzLFxuICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbnZpZXdzID0gcmVxdWlyZSgnLi4vdmlld3MnKTtcblxudmlld3MuSGVhZGVyVmlldyA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgX19leHRlbmRzKEhlYWRlclZpZXcsIF9zdXBlcik7XG5cbiAgZnVuY3Rpb24gSGVhZGVyVmlldyhvcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICBIZWFkZXJWaWV3Ll9fc3VwZXJfXy5jb25zdHJ1Y3Rvci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIHRoaXMucmVuZGVyKCk7XG4gIH1cblxuICBIZWFkZXJWaWV3LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbigpIHtcbiAgICAkKHRoaXMuZWwpLmh0bWwodGhpcy50ZW1wbGF0ZS5yZW5kZXIoKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgSGVhZGVyVmlldy5wcm90b3R5cGUuc2VsZWN0TWVudUl0ZW0gPSBmdW5jdGlvbihtZW51SXRlbSkge1xuICAgICQoXCIubmF2IGxpXCIpLnJlbW92ZUNsYXNzKFwiYWN0aXZlXCIpO1xuICAgIGlmIChtZW51SXRlbSkge1xuICAgICAgcmV0dXJuICQoXCIuXCIgKyBtZW51SXRlbSkuYWRkQ2xhc3MoXCJhY3RpdmVcIik7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiBIZWFkZXJWaWV3O1xuXG59KShCYWNrYm9uZS5WaWV3KTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS43LjFcbnZhciB2aWV3cyxcbiAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG52aWV3cyA9IHJlcXVpcmUoJy4uL3ZpZXdzJyk7XG5cbnZpZXdzLkhvbWVWaWV3ID0gKGZ1bmN0aW9uKF9zdXBlcikge1xuICBfX2V4dGVuZHMoSG9tZVZpZXcsIF9zdXBlcik7XG5cbiAgZnVuY3Rpb24gSG9tZVZpZXcob3B0aW9ucykge1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgSG9tZVZpZXcuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIEhvbWVWaWV3LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbigpIHtcbiAgICAkKHRoaXMuZWwpLmh0bWwodGhpcy50ZW1wbGF0ZS5yZW5kZXIoKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgcmV0dXJuIEhvbWVWaWV3O1xuXG59KShCYWNrYm9uZS5WaWV3KTtcbiIsIi8vIEdlbmVyYXRlZCBieSBDb2ZmZWVTY3JpcHQgMS43LjFcbnZhciB2aWV3cyxcbiAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG52aWV3cyA9IHJlcXVpcmUoJy4uL3ZpZXdzJyk7XG5cbnZpZXdzLlBhZ2luYXRvciA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgX19leHRlbmRzKFBhZ2luYXRvciwgX3N1cGVyKTtcblxuICBQYWdpbmF0b3IucHJvdG90eXBlLmNsYXNzTmFtZSA9IFwicGFnaW5hdGlvbiBwYWdpbmF0aW9uLWNlbnRlcmVkXCI7XG5cbiAgZnVuY3Rpb24gUGFnaW5hdG9yKG9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgIFBhZ2luYXRvci5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB0aGlzLm1vZGVsLmJpbmQoXCJyZXNldFwiLCB0aGlzLnJlbmRlciwgdGhpcyk7XG4gICAgdGhpcy5yZW5kZXIoKTtcbiAgfVxuXG4gIFBhZ2luYXRvci5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgdmFyIGksIGl0ZW1zLCBsZW4sIHBhZ2VDb3VudDtcbiAgICBpdGVtcyA9IHRoaXMubW9kZWwubW9kZWxzO1xuICAgIGxlbiA9IGl0ZW1zLmxlbmd0aDtcbiAgICBwYWdlQ291bnQgPSBNYXRoLmNlaWwobGVuIC8gOCk7XG4gICAgJCh0aGlzLmVsKS5odG1sKFwiPHVsIC8+XCIpO1xuICAgIGkgPSAwO1xuICAgIHdoaWxlIChpIDwgcGFnZUNvdW50KSB7XG4gICAgICAkKFwidWxcIiwgdGhpcy5lbCkuYXBwZW5kKFwiPGxpXCIgKyAoKGkgKyAxKSA9PT0gdGhpcy5vcHRpb25zLnBhZ2UgPyBcIiBjbGFzcz0nYWN0aXZlJ1wiIDogXCJcIikgKyBcIj48YSBocmVmPScjd2luZXMvcGFnZS9cIiArIChpICsgMSkgKyBcIic+XCIgKyAoaSArIDEpICsgXCI8L2E+PC9saT5cIik7XG4gICAgICBpKys7XG4gICAgfVxuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIHJldHVybiBQYWdpbmF0b3I7XG5cbn0pKEJhY2tib25lLlZpZXcpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIHZpZXdzLFxuICBfX2hhc1Byb3AgPSB7fS5oYXNPd25Qcm9wZXJ0eSxcbiAgX19leHRlbmRzID0gZnVuY3Rpb24oY2hpbGQsIHBhcmVudCkgeyBmb3IgKHZhciBrZXkgaW4gcGFyZW50KSB7IGlmIChfX2hhc1Byb3AuY2FsbChwYXJlbnQsIGtleSkpIGNoaWxkW2tleV0gPSBwYXJlbnRba2V5XTsgfSBmdW5jdGlvbiBjdG9yKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gY2hpbGQ7IH0gY3Rvci5wcm90b3R5cGUgPSBwYXJlbnQucHJvdG90eXBlOyBjaGlsZC5wcm90b3R5cGUgPSBuZXcgY3RvcigpOyBjaGlsZC5fX3N1cGVyX18gPSBwYXJlbnQucHJvdG90eXBlOyByZXR1cm4gY2hpbGQ7IH07XG5cbnZpZXdzID0gcmVxdWlyZSgnLi4vdmlld3MnKTtcblxudmlld3MuV2luZUxpc3RJdGVtVmlldyA9IChmdW5jdGlvbihfc3VwZXIpIHtcbiAgX19leHRlbmRzKFdpbmVMaXN0SXRlbVZpZXcsIF9zdXBlcik7XG5cbiAgV2luZUxpc3RJdGVtVmlldy5wcm90b3R5cGUudGFnTmFtZSA9IFwibGlcIjtcblxuICBmdW5jdGlvbiBXaW5lTGlzdEl0ZW1WaWV3KG9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgIFdpbmVMaXN0SXRlbVZpZXcuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG4gICAgdGhpcy5tb2RlbC5iaW5kKFwiY2hhbmdlXCIsIHRoaXMucmVuZGVyLCB0aGlzKTtcbiAgICB0aGlzLm1vZGVsLmJpbmQoXCJkZXN0cm95XCIsIHRoaXMuY2xvc2UsIHRoaXMpO1xuICB9XG5cbiAgV2luZUxpc3RJdGVtVmlldy5wcm90b3R5cGUucmVuZGVyID0gZnVuY3Rpb24oKSB7XG4gICAgJCh0aGlzLmVsKS5odG1sKHRoaXMudGVtcGxhdGUucmVuZGVyKHRoaXMubW9kZWwudG9KU09OKCkpKTtcbiAgICByZXR1cm4gdGhpcztcbiAgfTtcblxuICByZXR1cm4gV2luZUxpc3RJdGVtVmlldztcblxufSkoQmFja2JvbmUuVmlldyk7XG4iLCIvLyBHZW5lcmF0ZWQgYnkgQ29mZmVlU2NyaXB0IDEuNy4xXG52YXIgdmlld3MsXG4gIF9faGFzUHJvcCA9IHt9Lmhhc093blByb3BlcnR5LFxuICBfX2V4dGVuZHMgPSBmdW5jdGlvbihjaGlsZCwgcGFyZW50KSB7IGZvciAodmFyIGtleSBpbiBwYXJlbnQpIHsgaWYgKF9faGFzUHJvcC5jYWxsKHBhcmVudCwga2V5KSkgY2hpbGRba2V5XSA9IHBhcmVudFtrZXldOyB9IGZ1bmN0aW9uIGN0b3IoKSB7IHRoaXMuY29uc3RydWN0b3IgPSBjaGlsZDsgfSBjdG9yLnByb3RvdHlwZSA9IHBhcmVudC5wcm90b3R5cGU7IGNoaWxkLnByb3RvdHlwZSA9IG5ldyBjdG9yKCk7IGNoaWxkLl9fc3VwZXJfXyA9IHBhcmVudC5wcm90b3R5cGU7IHJldHVybiBjaGlsZDsgfTtcblxudmlld3MgPSByZXF1aXJlKCcuLi92aWV3cycpO1xuXG52aWV3cy5XaW5lTGlzdFZpZXcgPSAoZnVuY3Rpb24oX3N1cGVyKSB7XG4gIF9fZXh0ZW5kcyhXaW5lTGlzdFZpZXcsIF9zdXBlcik7XG5cbiAgZnVuY3Rpb24gV2luZUxpc3RWaWV3KG9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICAgIFdpbmVMaXN0Vmlldy5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB0aGlzLnJlbmRlcigpO1xuICB9XG5cbiAgV2luZUxpc3RWaWV3LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgZW5kUG9zLCBpLCBsZW4sIHN0YXJ0UG9zLCB3aW5lcztcbiAgICB3aW5lcyA9IHRoaXMubW9kZWwubW9kZWxzO1xuICAgIGxlbiA9IHdpbmVzLmxlbmd0aDtcbiAgICBzdGFydFBvcyA9ICh0aGlzLm9wdGlvbnMucGFnZSAtIDEpICogODtcbiAgICBlbmRQb3MgPSBNYXRoLm1pbihzdGFydFBvcyArIDgsIGxlbik7XG4gICAgJCh0aGlzLmVsKS5odG1sKFwiPHVsIGNsYXNzPVxcXCJ0aHVtYm5haWxzXFxcIj48L3VsPlwiKTtcbiAgICBpID0gc3RhcnRQb3M7XG4gICAgd2hpbGUgKGkgPCBlbmRQb3MpIHtcbiAgICAgICQoXCIudGh1bWJuYWlsc1wiLCB0aGlzLmVsKS5hcHBlbmQobmV3IHZpZXdzLldpbmVMaXN0SXRlbVZpZXcoe1xuICAgICAgICBtb2RlbDogd2luZXNbaV1cbiAgICAgIH0pLnJlbmRlcigpLmVsKTtcbiAgICAgIGkrKztcbiAgICB9XG4gICAgJCh0aGlzLmVsKS5hcHBlbmQobmV3IHZpZXdzLlBhZ2luYXRvcih7XG4gICAgICBtb2RlbDogdGhpcy5tb2RlbCxcbiAgICAgIHBhZ2U6IHRoaXMub3B0aW9ucy5wYWdlXG4gICAgfSkucmVuZGVyKCkuZWwpO1xuICAgIHJldHVybiB0aGlzO1xuICB9O1xuXG4gIHJldHVybiBXaW5lTGlzdFZpZXc7XG5cbn0pKEJhY2tib25lLlZpZXcpO1xuIiwiLy8gR2VuZXJhdGVkIGJ5IENvZmZlZVNjcmlwdCAxLjcuMVxudmFyIHV0aWxzLCB2aWV3cyxcbiAgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG4gIF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9O1xuXG51dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzJyk7XG5cbnZpZXdzID0gcmVxdWlyZSgnLi4vdmlld3MnKTtcblxudmlld3MuV2luZVZpZXcgPSAoZnVuY3Rpb24oX3N1cGVyKSB7XG4gIF9fZXh0ZW5kcyhXaW5lVmlldywgX3N1cGVyKTtcblxuICBmdW5jdGlvbiBXaW5lVmlldyhvcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgICBXaW5lVmlldy5fX3N1cGVyX18uY29uc3RydWN0b3IuYXBwbHkodGhpcywgYXJndW1lbnRzKTtcbiAgICB0aGlzLnJlbmRlcigpO1xuICB9XG5cbiAgV2luZVZpZXcucHJvdG90eXBlLnJlbmRlciA9IGZ1bmN0aW9uKCkge1xuICAgICQodGhpcy5lbCkuaHRtbCh0aGlzLnRlbXBsYXRlLnJlbmRlcih0aGlzLm1vZGVsLnRvSlNPTigpKSk7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH07XG5cbiAgV2luZVZpZXcucHJvdG90eXBlLmV2ZW50cyA9IGZ1bmN0aW9uKCkge1xuICAgIHJldHVybiB7XG4gICAgICBcImNoYW5nZVwiOiBcImNoYW5nZVwiLFxuICAgICAgXCJjbGljayAuc2F2ZVwiOiBcImJlZm9yZVNhdmVcIixcbiAgICAgIFwiY2xpY2sgLmRlbGV0ZVwiOiBcImRlbGV0ZVdpbmVcIixcbiAgICAgIFwiZHJvcCAjcGljdHVyZVwiOiBcImRyb3BIYW5kbGVyXCJcbiAgICB9O1xuICB9O1xuXG4gIFdpbmVWaWV3LnByb3RvdHlwZS5jaGFuZ2UgPSBmdW5jdGlvbihldmVudCkge1xuICAgIHZhciBjaGFuZ2UsIGNoZWNrLCB0YXJnZXQ7XG4gICAgdXRpbHMuaGlkZUFsZXJ0KCk7XG4gICAgdGFyZ2V0ID0gZXZlbnQudGFyZ2V0O1xuICAgIGNoYW5nZSA9IHt9O1xuICAgIGNoYW5nZVt0YXJnZXQubmFtZV0gPSB0YXJnZXQudmFsdWU7XG4gICAgdGhpcy5tb2RlbC5zZXQoY2hhbmdlKTtcbiAgICBjaGVjayA9IHRoaXMubW9kZWwudmFsaWRhdGVJdGVtKHRhcmdldC5pZCk7XG4gICAgaWYgKGNoZWNrLmlzVmFsaWQgPT09IGZhbHNlKSB7XG4gICAgICByZXR1cm4gdXRpbHMuYWRkVmFsaWRhdGlvbkVycm9yKHRhcmdldC5pZCwgY2hlY2subWVzc2FnZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB1dGlscy5yZW1vdmVWYWxpZGF0aW9uRXJyb3IodGFyZ2V0LmlkKTtcbiAgICB9XG4gIH07XG5cbiAgV2luZVZpZXcucHJvdG90eXBlLmJlZm9yZVNhdmUgPSBmdW5jdGlvbigpIHtcbiAgICB2YXIgY2hlY2s7XG4gICAgY2hlY2sgPSB0aGlzLm1vZGVsLnZhbGlkYXRlQWxsKCk7XG4gICAgaWYgKGNoZWNrLmlzVmFsaWQgPT09IGZhbHNlKSB7XG4gICAgICB1dGlscy5kaXNwbGF5VmFsaWRhdGlvbkVycm9ycyhjaGVjay5tZXNzYWdlcyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHRoaXMuc2F2ZVdpbmUoKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgV2luZVZpZXcucHJvdG90eXBlLnNhdmVXaW5lID0gZnVuY3Rpb24oKSB7XG4gICAgY29uc29sZS5sb2coXCJiZWZvcmUgc2F2ZVwiKTtcbiAgICByZXR1cm4gdGhpcy5tb2RlbC5zYXZlKG51bGwsIHtcbiAgICAgIHN1Y2Nlc3M6IChmdW5jdGlvbihfdGhpcykge1xuICAgICAgICByZXR1cm4gZnVuY3Rpb24obW9kZWwpIHtcbiAgICAgICAgICBfdGhpcy5yZW5kZXIoKTtcbiAgICAgICAgICBhcHAubmF2aWdhdGUoXCJ3aW5lcy9cIiArIG1vZGVsLmlkLCBmYWxzZSk7XG4gICAgICAgICAgcmV0dXJuIHV0aWxzLnNob3dBbGVydChcIlN1Y2Nlc3MhXCIsIFwiV2luZSBzYXZlZCBzdWNjZXNzZnVsbHlcIiwgXCJhbGVydC1zdWNjZXNzXCIpO1xuICAgICAgICB9O1xuICAgICAgfSkodGhpcyksXG4gICAgICBlcnJvcjogZnVuY3Rpb24oKSB7XG4gICAgICAgIHJldHVybiB1dGlscy5zaG93QWxlcnQoXCJFcnJvclwiLCBcIkFuIGVycm9yIG9jY3VycmVkIHdoaWxlIHRyeWluZyB0byBkZWxldGUgdGhpcyBpdGVtXCIsIFwiYWxlcnQtZXJyb3JcIik7XG4gICAgICB9XG4gICAgfSk7XG4gIH07XG5cbiAgV2luZVZpZXcucHJvdG90eXBlLmRlbGV0ZVdpbmUgPSBmdW5jdGlvbigpIHtcbiAgICB0aGlzLm1vZGVsLmRlc3Ryb3koe1xuICAgICAgc3VjY2VzczogZnVuY3Rpb24oKSB7XG4gICAgICAgIGFsZXJ0KFwiV2luZSBkZWxldGVkIHN1Y2Nlc3NmdWxseVwiKTtcbiAgICAgICAgcmV0dXJuIHdpbmRvdy5oaXN0b3J5LmJhY2soKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgV2luZVZpZXcucHJvdG90eXBlLmRyb3BIYW5kbGVyID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgICB2YXIgZSwgcmVhZGVyO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZSA9IGV2ZW50Lm9yaWdpbmFsRXZlbnQ7XG4gICAgZS5kYXRhVHJhbnNmZXIuZHJvcEVmZmVjdCA9IFwiY29weVwiO1xuICAgIHRoaXMucGljdHVyZUZpbGUgPSBlLmRhdGFUcmFuc2Zlci5maWxlc1swXTtcbiAgICByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICAgIHJlYWRlci5vbmxvYWRlbmQgPSBmdW5jdGlvbigpIHtcbiAgICAgIHJldHVybiAkKFwiI3BpY3R1cmVcIikuYXR0cihcInNyY1wiLCByZWFkZXIucmVzdWx0KTtcbiAgICB9O1xuICAgIHJldHVybiByZWFkZXIucmVhZEFzRGF0YVVSTCh0aGlzLnBpY3R1cmVGaWxlKTtcbiAgfTtcblxuICByZXR1cm4gV2luZVZpZXc7XG5cbn0pKEJhY2tib25lLlZpZXcpO1xuIl19
